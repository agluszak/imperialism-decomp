# Agent Guidelines (Imperialism RE)

## Goal
Maintain steady reverse-engineering progress in Ghidra using safe, evidence-based batch improvements.

## Environment
- Python: `.venv/bin/python`
- Ghidra install:
  - `/home/andrzej.gluszak/Downloads/ghidra_12.0.2_PUBLIC_20260129/ghidra_12.0.2_PUBLIC`
- Project/program:
  - project name: `imperialism-decomp`
  - program path: `/Imperialism.exe`

## Non-Negotiables
- Default to direct pyghidra scripting; do not use MCP for core rename/typing work unless explicitly needed.
- Keep one writer process at a time. Never run concurrent pyghidra write scripts.
- Keep one execution path per pass (no mixed MCP/direct writes in the same batch).
- Do not run dependent read commands in parallel when one consumes files generated by another.
- Rename/type only when supported by decomp/callers/constants; avoid speculative semantic naming.
- Update signatures where role/ABI is clear.
- Keep Neo4j for high-level concepts only, not low-level rename spam.
- Keep `TODO.md` as active queue only (max 3 in-progress items).

## Hard Fixes (Do Not Repeat)
1) Heredoc redirection syntax:
- Always attach redirection on the `python` command line, not after the terminator.
- For ad-hoc Python probes, prefer a temp script file (`/tmp/<name>.py`) over inline heredocs.
- Correct pattern:
```bash
.venv/bin/python - <<'PY' > tmp_decomp/<file>.log 2>&1
# python body
PY
sed -n '1,120p' tmp_decomp/<file>.log
```
- Forbidden pattern:
```bash
.venv/bin/python - <<'PY'
# body
PY > file.log 2>&1; sed ...
```

2) Ghidra writer serialization:
- Never run writer scripts in `parallel` calls.
- Treat any script that can rename/type/create comments/data/labels as a writer.
- Run writers strictly sequentially, one command per call.
- After each writer, wait briefly before the next writer:
```bash
sleep 1
```
- If a save/lock error appears, rerun that writer alone and do not continue until it saves cleanly.

## P0 Invariants (Always On)
- Strict super-lane gate must stay zero:
  - `new_scripts/find_named_functions_with_generic_callees.py`
- Runtime bridge unresolved gate must stay zero (`0x00600000..0x0062ffff`):
  - `new_scripts/list_unresolved_functions_in_range.py`
- Progress counters and artifacts must be emitted every wave:
  - `new_scripts/count_re_progress.py`
- If a wave regresses strict/runtime gates, fix immediately before starting a new lane.

## Wave (Canonical)
A **wave** is one coherent batch that performs:
1) apply rename CSV,  
2) apply signature CSV,  
3) apply thunk-signature propagation,  
4) emit post-wave artifacts:
- unresolved main snapshot,
- strict super-lane gate,
- runtime bridge gate,
- progress counters.

Default implementation:
- `new_scripts/run_unresolved_wave.py`
- `new_scripts/run_wave_bundle.py` (preferred wrapper: runs pre snapshots + optional callback ABI pass + wave + post snapshots)

## Default Workflow
Use this as the standard loop driver:

```bash
.venv/bin/python new_scripts/run_wave_bundle.py \
  --batch-tag <batch_tag> \
  --renames-csv <renames.csv> \
  --signatures-csv <signatures.csv> \
  --thunk-signatures-csv <thunk_sigs.csv> \
  --auto-thunk-mirrors \
  --apply
```

Use single-purpose scripts only for surgical debug/fixups.

Artifact policy:
- Default: summary-only output from `run_wave_bundle.py` (minimal file churn).
- Use `--emit-detail-artifacts` only when debugging or when a lane needs full CSV traces.

## Core Script Set
- `new_scripts/run_unresolved_wave.py`: primary wave execution.
- `new_scripts/dump_function_context.py`: quick semantic validation before naming.
- `new_scripts/list_unresolved_functions_in_range.py`: unresolved ranking/snapshot.
- `new_scripts/find_named_functions_with_generic_callees.py`: strict super-lane gate.
- `new_scripts/count_re_progress.py`: project counters.
- `new_scripts/apply_function_renames_csv.py`: targeted rename-only patches.
- `new_scripts/apply_signatures_from_csv.py`: targeted signature-only patches.
- `new_scripts/apply_thunk_target_signatures_from_csv.py`: targeted thunk sig propagation.

## Reusable Script Rule
- Prefer reusable scripts under `new_scripts/` for recurring filters/builders.
- Do not rely on ad-hoc inline generators for repeatable rename/signature wave prep.
- If a repeatable helper is missing, add a script first, then run it.
- Keep one active wave CSV per lane and append to it frequently during triage.
- Do not create many tiny one-off CSV files when rows can be appended to the current wave CSV.

## Naming / Typing Policy
- Prefer behavior-based names when uncertain.
- Rename direct thunk mirrors with their targets when obvious.
- Keep batch intent coherent (one lane/family per wave).
- Improve variable names/types incrementally where it materially improves readability.

## Quality Gates
After each wave:
- strict super-lane gate must be `0` rows,
- runtime bridge unresolved (`0x0060xxxx..0x0062xxxx`) must be `0` rows,
- if non-zero, do immediate fix-up wave before new lane work.

## Documentation Discipline
- `TODO.md` = active queue only.
- Move completed work to `agent_2.md` with minimal batch summaries.
- Keep per-wave artifacts in `tmp_decomp/` with clear batch naming.

## Knowledge Sources
- Neo4j contains high-level Imperialism domain knowledge and resource mappings (bitmaps/strings/tables).
- `manual_text.txt` is available for gameplay semantics.
- If Neo4j is unavailable and needed, ask user for context rather than blocking.

## FID and Advanced Lanes
- Use FID as an accelerator, not blind rename authority.
- Only apply high-confidence unresolved single-match items.
- Keep full FID mechanics in:
  - `msvc500-fid-workflow.md`
  - `msvc500-fid-dehardcode-plan.md`
- angr/claripy experimentation is allowed, but final results must be reflected in Ghidra.

## Safety
- Never revert unrelated user changes.
- Never use destructive git commands.
- If unexpected workspace mutations appear, stop and ask user how to proceed.
