# Agent Guidelines (Imperialism RE)

## Goal
Maintain steady reverse-engineering progress in Ghidra using safe, evidence-based batch improvements.

## Environment
- Python / project management: `uv` (`uv sync`, `uv run ...`)
- Bootstrap: `uv sync --dev`
- Ghidra install:
  - `/home/andrzej.gluszak/Downloads/ghidra_12.0.2_PUBLIC_20260129/ghidra_12.0.2_PUBLIC`
- Project/program:
  - project name: `imperialism-decomp`
  - program path: `/Imperialism.exe`

## Non-Negotiables
- Use maintained CLI commands via `uv run impk <command>` as the default interface.
- Treat `new_scripts/` as legacy compatibility only; do not add new files there.
- If functionality is missing, implement it once under `src/imperialism_re/commands/` and register it in `src/imperialism_re/command_catalog.yaml`.
- Default to direct pyghidra scripting; do not use MCP for core rename/typing work unless explicitly needed.
- Keep one writer process at a time. Never run concurrent pyghidra write scripts.
- Keep one execution path per pass (no mixed MCP/direct writes in the same batch).
- Do not run dependent read commands in parallel when one consumes files generated by another.
- Rename/type only when supported by decomp/callers/constants; avoid speculative semantic naming.
- Update signatures where role/ABI is clear.
- Keep Neo4j for high-level concepts only, not low-level rename spam.
- Keep `TODO.md` as active queue only (max 3 in-progress items).

## Hard Fixes (Do Not Repeat)
0) Python execution: ALWAYS use `uv run python` or `uv run impk`. NEVER invoke `python3`, `python`, or `pytest` directly. System Python is not the project interpreter.
- Tests: `uv run pytest`
- Ad-hoc scripts: `uv run python -c "..."` or `uv run python /tmp/probe.py`
- Commands: `uv run impk <command>`

1) Heredoc redirection syntax:
- Always attach redirection on the `python` command line, not after the terminator.
- For ad-hoc Python probes, prefer a temp script file (`/tmp/<name>.py`) over inline heredocs.
- Correct pattern:
```bash
uv run python - <<'PY' > tmp_decomp/<file>.log 2>&1
# python body
PY
sed -n '1,120p' tmp_decomp/<file>.log
```
- Forbidden pattern:
```bash
uv run python - <<'PY'
# body
PY > file.log 2>&1; sed ...
```

2) Ghidra writer serialization:
- Never run writer scripts in `parallel` calls.
- Treat any script that can rename/type/create comments/data/labels as a writer.
- Run writers strictly sequentially, one command per call.
- After each writer, wait briefly before the next writer:
```bash
sleep 1
```
- If a save/lock error appears, rerun that writer alone and do not continue until it saves cleanly.

## P0 Invariants (Always On)
- Strict super-lane gate must stay zero:
  - `uv run impk find_named_functions_with_generic_callees`
- Runtime bridge unresolved gate must stay zero (`0x00600000..0x0062ffff`):
  - `uv run impk list_unresolved_functions_in_range`
- Progress counters and artifacts must be emitted every wave:
  - `uv run impk count_re_progress`
- If a wave regresses strict/runtime gates, fix immediately before starting a new lane.

## Wave (Canonical)
A **wave** is one coherent batch that performs:
1) apply rename CSV,  
2) apply signature CSV,  
3) apply thunk-signature propagation,  
4) emit post-wave artifacts:
- unresolved main snapshot,
- strict super-lane gate,
- runtime bridge gate,
- progress counters.

Default implementation:
- `uv run impk run_unresolved_wave`
- `uv run impk run_wave_bundle` (preferred wrapper: runs pre snapshots + optional callback ABI pass + wave + post snapshots)

## Default Workflow
Use this as the standard loop driver:

```bash
uv run impk run_wave_bundle \
  --batch-tag <batch_tag> \
  --renames-csv <renames.csv> \
  --signatures-csv <signatures.csv> \
  --thunk-signatures-csv <thunk_sigs.csv> \
  --auto-thunk-mirrors \
  --apply
```

Use single-purpose maintained commands only for surgical debug/fixups.

Artifact policy:
- Default: summary-only output from `run_wave_bundle.py` (minimal file churn).
- Use `--emit-detail-artifacts` only when debugging or when a lane needs full CSV traces.

## Core Script Set
- `uv run impk run_unresolved_wave`: primary wave execution.
- `uv run impk dump_function_context`: quick semantic validation before naming.
- `uv run impk list_unresolved_functions_in_range`: unresolved ranking/snapshot.
- `uv run impk find_named_functions_with_generic_callees`: strict super-lane gate.
- `uv run impk count_re_progress`: project counters.
- `uv run impk apply_function_renames_csv`: targeted rename-only patches.
- `uv run impk apply_signatures_from_csv`: targeted signature-only patches.
- `uv run impk apply_thunk_target_signatures_from_csv`: targeted thunk sig propagation.

## Reusable Script Rule
- Prefer reusable command modules under `src/imperialism_re/commands/` for recurring filters/builders.
- Do not rely on ad-hoc inline generators for repeatable rename/signature wave prep.
- If a repeatable helper is missing, add one maintained command module (not a throwaway script), then run it through `uv run impk`.
- Keep one active wave CSV per lane and append to it frequently during triage.
- Do not create many tiny one-off CSV files when rows can be appended to the current wave CSV.

## Tooling Hygiene
- Before using a command, prefer `uv run impk list` and use an existing maintained entry if available.
- Avoid command duplication: do not create near-identical command modules with small argument differences.
- When consolidating behavior, extend an existing maintained command with flags instead of adding a parallel variant.
- Keep logs/artifacts minimal and purpose-driven; avoid generating extra files that do not affect analysis or application.

## Naming / Typing Policy
- Prefer behavior-based names when uncertain.
- Rename direct thunk mirrors with their targets when obvious.
- Keep batch intent coherent (one lane/family per wave).
- Improve variable names/types incrementally where it materially improves readability.

## Quality Gates
After each wave:
- strict super-lane gate must be `0` rows,
- runtime bridge unresolved (`0x0060xxxx..0x0062xxxx`) must be `0` rows,
- if non-zero, do immediate fix-up wave before new lane work.

## Quality Pass (Full Audit)

Run after every major batch of attribution or rename work, and at the start of a
new session to get a project health snapshot.

```bash
uv run impk run_qc_pass
# or save machine-readable issues:
uv run impk run_qc_pass --out-csv tmp_decomp/qc_report.csv
```

The pass checks 7 categories in one Ghidra session:

| # | Check | Critical? |
|---|---|---|
| 1 | Class assignment progress (% attributed __thiscall) | No |
| 2 | Strict super-lane gate — named class fn calling only generic callees | **Yes** |
| 3 | Stale thunk names — `thunk_Foo` where JMP target is no longer `Foo` | No |
| 4 | Stale wrapper names — `WrapperFor_Foo_AtX` where target renamed | No |
| 5 | `FID_conflict:` prefix leftovers | No |
| 6 | Duplicate (class, name) pairs — junk-drawer signal | No |
| 7 | Unknown/default calling conventions on named functions | **Yes** |

Exits with code 1 if any critical gate fails.

### Fixing stale names (thunks and wrappers)

When check 3 shows stale thunks:
```bash
uv run impk generate_single_jmp_thunk_pairs --out-csv tmp_decomp/qc_thunk_pairs.csv
# then filter + apply with apply_fid_candidates --override-conflicts --apply
```

When check 4 shows stale wrappers:
```bash
uv run impk generate_stale_wrapper_renames --out-csv tmp_decomp/stale_wrapper_renames.csv
uv run impk apply_fid_candidates \
    --in-csv tmp_decomp/stale_wrapper_renames.csv \
    --override-conflicts --apply
```

### Attribution Audit (periodic, ~quarterly waves)

When check 1 regresses unexpectedly, or after bulk attribution, run a full audit:
1. Export all functions: `uv run impk list_functions_in_range --out-csv tmp_decomp/all_fns.csv`
2. Check for junk-drawer signals:
   - Classes with no vtable and large counts of SDDs / OrphanVtableAssignStubs
   - Thunk clusters (`thunk_DestructFooBaseState` ×N) that belong to *derived* classes
   - MFC class names containing game-logic functions
   - Excess duplicate names (same method name ×N in one namespace)
3. Revert suspect assignments with `move_functions_to_global_namespace_csv`
4. Re-run all 4 inference commands to recover correct attributions

## Documentation Discipline
- `TODO.md` = active queue only.
- Move completed work to `agent_2.md` with minimal batch summaries.
- Keep per-wave artifacts in `tmp_decomp/` with clear batch naming.

## Knowledge Sources
- Neo4j contains high-level Imperialism domain knowledge and resource mappings (bitmaps/strings/tables).
- `manual_text.txt` is available for gameplay semantics.
- If Neo4j is unavailable and needed, ask user for context rather than blocking.

## macOS Binary Reference (Vocabulary)

The Power Macintosh port (`Imperialism_macos` in the Ghidra project) ships with full
Cfront-style C++ debug names. It provides ground-truth method inventories for 508 classes.

Reference files (in `tmp_decomp/`):
- `macos_class_methods.csv` — 2,210 rows: class→method mapping (primary lookup)
- `macos_global_functions.csv` — 1,040 rows: non-class global functions
- `macos_debug_symbols.csv` — 3,441 rows: raw full dump

See `docs/macos-debug-symbols.md` for architecture details, name mangling format, class
inventory, and BSim cross-arch caveats.

**Do NOT apply BSim cross-arch (macOS↔Windows) matches as renames** without manual
semantic validation — even sim=1.0 cross-arch matches can be false positives.
Use `macos_class_methods.csv` as a vocabulary reference instead.

## FID and Advanced Lanes
- Use FID as an accelerator, not blind rename authority.
- Only apply high-confidence unresolved single-match items.
- Keep full FID mechanics in:
  - `msvc500-fid-workflow.md`
  - `msvc500-fid-dehardcode-plan.md`
- angr/claripy experimentation is allowed, but final results must be reflected in Ghidra.

## Safety
- Never revert unrelated user changes.
- Never use destructive git commands.
- If unexpected workspace mutations appear, stop and ask user how to proceed.
